<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Grepping logs without data loss · Yet another programming blog</title><meta name="description" content="A Blog Powered By Hexo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">Home</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   Blog</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li><li class="nav-list-item"><a href="https://github.com/vsuharnikov" target="_blank" class="nav-link" rel="external nofollow noopener noreferrer">   github</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2017/02/26/grepping-logs-without-data-loss/" class="post-title-link">Grepping logs without data loss</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/scala/" class="post-tag-link">scala</a></li><li class="post-tag-item"><a href="/tags/logback/" class="post-tag-link">logback</a></li><li class="post-tag-item"><a href="/tags/grep/" class="post-tag-link">grep</a></li></ul><div class="post-time">Sunday, February 26th 2017</div></div><div class="post-content"><p><a href="#Solution">Solution</a></p>
<p>I use the <em>grep</em> to filter out logs, when the ELK is overkill. But, sometimes log entries have multiple lines and<br>the grepped result doesn’t contain all lines.</p>
<p>Let’s see an example.</p>
<p>logback.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.FileAppender"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>application.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>[%d&#123;HH:mm:ss.SSS&#125;] %-5level %logger&#123;5&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"example"</span> <span class="attr">level</span>=<span class="string">"TRACE"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>Main.scala:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> example</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.typesafe.scalalogging.<span class="type">StrictLogging</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Secondary</span> <span class="keyword">extends</span> <span class="title">StrictLogging</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">test</span></span>(): <span class="type">Unit</span> = logger.trace(<span class="string">"&#123;&#125;\n&#123;&#125;"</span>, <span class="string">"baz"</span>, <span class="string">"qux"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">App</span> <span class="keyword">with</span> <span class="title">StrictLogging</span> </span>&#123;</div><div class="line">  logger.trace(<span class="string">"&#123;&#125;\n&#123;&#125;"</span>, <span class="string">"foo"</span>, <span class="string">"bar"</span>)</div><div class="line">  <span class="type">Secondary</span>.test()</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>When you run this code, the <em>application.log</em> will contain:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[11:40:53.882] TRACE e.Main$ - foo</div><div class="line">bar</div><div class="line">[11:40:53.891] TRACE e.Secondary$ - baz</div><div class="line">qux</div></pre></td></tr></table></figure></p>
<p>Obviously, <code>grep Main application.log</code> outputs:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[11:40:53.882] TRACE e.Main$ - foo</div></pre></td></tr></table></figure></p>
<p>and the <code>bar</code> is missing.</p>
<p>So, the desired logs are:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[11:40:53.882] TRACE e.Main$ - foo</div><div class="line">[11:40:53.882] TRACE e.Main$ - bar</div><div class="line">[11:40:53.891] TRACE e.Secondary$ - baz</div><div class="line">[11:40:53.891] TRACE e.Secondary$ - qux</div></pre></td></tr></table></figure></p>
<h3 id="How-to-do-it"><a href="#How-to-do-it" class="headerlink" title="How to do it?"></a>How to do it?</h3><p>An each log entry has a prefix (<code>[11:40:53.882] TRACE e.Main$ -</code>).<br>We need to transform a log entry’s message in a such way:</p>
<ol>
<li>Get the prefix by a separator;</li>
<li>Replace all newlines by the prefix.</li>
</ol>
<p>Seems, we need a <em>ch.qos.logback.core.pattern.Converter</em>, that receives an argument (our separator).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Converter</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">    * The convert method is responsible for extracting data from the event and</div><div class="line">    * storing it for later use by the write method.</div><div class="line">    */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">convert</span><span class="params">(E event)</span></span>;</div></pre></td></tr></table></figure></p>
<p>Such class exists in the <em>logback</em>, it is <em>ch.qos.logback.core.pattern.CompositeConverter</em>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompositeConverter</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">DynamicConverter</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">  <span class="comment">// ...</span></div><div class="line">  <span class="function"><span class="keyword">abstract</span> <span class="keyword">protected</span> String <span class="title">transform</span><span class="params">(E event, String in)</span></span>;</div></pre></td></tr></table></figure></p>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><ol>
<li><p>Add <em>PrefixCompositeConverter</em> to your project:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> log</div><div class="line"></div><div class="line"><span class="keyword">import</span> ch.qos.logback.core.pattern.<span class="type">CompositeConverter</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrefixCompositeConverter</span>[<span class="type">E</span>] <span class="keyword">extends</span> <span class="title">CompositeConverter</span>[<span class="type">E</span>] </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">    * A splitter between the prefix and the message</div><div class="line">    */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">var</span> splitter: <span class="type">String</span> = _</div><div class="line"></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">start</span></span>(): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="type">Option</span>(getOptionList) <span class="keyword">match</span> &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">Some</span>(xs) <span class="keyword">if</span> xs.size() == <span class="number">1</span> =&gt;</div><div class="line">        splitter = xs.get(<span class="number">0</span>)</div><div class="line">        <span class="keyword">super</span>.start()</div><div class="line"></div><div class="line">      <span class="keyword">case</span> _ =&gt;</div><div class="line">        addError(<span class="string">"Please, specify the splitter"</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">transform</span></span>(event: <span class="type">E</span>, in: <span class="type">String</span>): <span class="type">String</span> = &#123;</div><div class="line">    <span class="keyword">if</span> (started) &#123;</div><div class="line">      in.indexOf(splitter) <span class="keyword">match</span> &#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">-1</span> =&gt; in</div><div class="line">        <span class="keyword">case</span> i =&gt;</div><div class="line">          <span class="keyword">val</span> (prefix, rest) = in.splitAt(i)</div><div class="line">          <span class="comment">// \n is *nix-only ;)</span></div><div class="line">          prefix + rest.substring(splitter.length).replace(<span class="string">"\n"</span>, <span class="string">s"\n<span class="subst">$prefix</span>"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> in</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Change the <em>logback.xml</em> to:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">"prefix"</span> <span class="attr">converterClass</span>=<span class="string">"log.PrefixCompositeConverter"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%prefix([%d&#123;HH:mm:ss.SSS&#125;] [%thread] %highlight(%-5level) %logger&#123;5&#125; - |%msg)&#123;"|"&#125;%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"example"</span> <span class="attr">level</span>=<span class="string">"TRACE"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"ERROR"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>Now, the <em>application.log</em> is:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[12:28:31.502] TRACE e.Main$ - foo</div><div class="line">[12:28:31.502] TRACE e.Main$ - bar</div><div class="line">[12:28:31.540] TRACE e.Secondary$ - baz</div><div class="line">[12:28:31.540] TRACE e.Secondary$ - qux</div></pre></td></tr></table></figure></p>
<p>Done!</p>
</div></article><div class="pagination"><a href="/2017/03/03/javafx-scala/" class="pagination-prev">PREV</a><a href="/2016/12/11/dotty-error-handling/" class="pagination-next">NEXT</a></div><div class="comments"></div></div><aside class="sidebar"><h3>Tags</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/dotty/">dotty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/error/">error</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grep/">grep</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javafx/">javafx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logback/">logback</a></li></ul><h3>Posts</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/13/sbt-library-dependencies/">SBT and MissingRequirementError</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/03/javafx-scala/">Working with JavaFX in Scala</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/26/grepping-logs-without-data-loss/">Grepping logs without data loss</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/11/dotty-error-handling/">Working with domain-specific errors in Dotty</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><p>© 2017 <a href="/">Vyatcheslav Suharnikov</a></p></div><div class="power"><p><a rel="external nofollow noopener noreferrer" href="http://pinggod.com/" target="_blank">Sean Sun</a>, 
<a rel="external nofollow noopener noreferrer" href="https://hexo.io" target="_blank">Hexo</a>, 
<a rel="external nofollow noopener noreferrer" href="https://github.com/" target="_blank">GitHub</a>, 
<a rel="external nofollow noopener noreferrer" href="https://jekyllrb.com/" target="_blank">Jekyll</a></p></div></div></footer><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>